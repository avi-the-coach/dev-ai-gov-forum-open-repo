<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Webinar Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            color: #000000;
            min-height: 100vh;
            padding: 20px;
        }

        /* Login Screen Styles */
        body.login-mode {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .login-container {
            display: none;
            background: white;
            padding: 60px 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 450px;
            width: 90%;
        }

        body.login-mode .login-container {
            display: block;
        }

        .login-container h1 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: none;
        }

        .login-container p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1rem;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            width: 100%;
        }

        .upload-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .error-message {
            color: #ff4757;
            margin-top: 20px;
            font-weight: bold;
            min-height: 24px;
        }

        #fileInput {
            display: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            color: #9333ea;
            text-shadow: 0 0 10px rgba(147, 51, 234, 0.3);
            font-weight: 300;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
            color: white;
            border: 2px solid;
        }

        .status-idle {
            background: #666;
            border-color: #666;
        }
        .status-registration {
            background: #ffa502;
            border-color: #ffa502;
        }
        .status-practice {
            background: #3742fa;
            border-color: #3742fa;
        }
        .status-active {
            background: #2ed573;
            border-color: #2ed573;
            animation: pulse 2s infinite;
        }
        .status-ended {
            background: #ff4757;
            border-color: #ff4757;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #9333ea;
            box-shadow: 0 10px 30px rgba(147, 51, 234, 0.2);
        }

        .card h2 {
            margin-bottom: 15px;
            font-size: 1.5rem;
            color: #9333ea;
            font-weight: 500;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            background: #f9f9f9;
            color: #000;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #9333ea;
            background: #ffffff;
        }

        button {
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Button row layout */
        .button-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .button-row button {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            white-space: pre-wrap;
            line-height: 1.3;
            margin: 0;
        }

        .divider {
            margin: 30px 0;
            border: none;
            border-top: 2px solid #e0e0e0;
        }

        .btn-primary {
            background: #9333ea;
            border: 2px solid #9333ea;
            color: white;
        }

        .btn-primary:hover {
            background: #a855f7;
            border-color: #a855f7;
        }

        .btn-success {
            background: #2ed573;
            border: 2px solid #2ed573;
            color: white;
        }

        .btn-success:hover {
            background: #26de81;
            border-color: #26de81;
        }

        .btn-danger {
            background: #ff4757;
            border: 2px solid #ff4757;
            color: white;
        }

        .btn-danger:hover {
            background: #ff6348;
            border-color: #ff6348;
        }

        .btn-warning {
            background: #ffa502;
            border: 2px solid #ffa502;
            color: white;
        }

        .btn-warning:hover {
            background: #ff6348;
            border-color: #ff6348;
        }

        .btn-info {
            background: #3742fa;
            border: 2px solid #3742fa;
            color: white;
        }

        .btn-info:hover {
            background: #5352ed;
            border-color: #5352ed;
        }

        .btn-danger-alt {
            background: #8B0000;
            border: 2px solid #8B0000;
            color: white;
        }

        .btn-danger-alt:hover {
            background: #a00000;
            border-color: #a00000;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #9333ea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .leaderboard {
            max-height: 400px;
            overflow-y: auto;
        }

        .player-row-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            flex: 1;
        }

        .player-row.red {
            border-right: 4px solid #ff4757;
            background: rgba(255, 71, 87, 0.05);
        }
        .player-row.green {
            border-right: 4px solid #2ed573;
            background: rgba(46, 213, 115, 0.05);
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            flex: 1;
        }

        .delete-player-btn {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid #ff4757;
            color: #ff4757;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-player-btn:hover {
            background: #ff4757;
            color: white;
            transform: scale(1.1);
        }

        .connection-status {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            border: 2px solid;
        }

        .connection-connected {
            background: rgba(46, 213, 115, 0.1);
            color: #2ed573;
            border-color: #2ed573;
        }

        .connection-disconnected {
            background: rgba(255, 71, 87, 0.1);
            color: #ff4757;
            border-color: #ff4757;
        }

        .timer-display {
            font-size: 3rem;
            text-align: center;
            font-weight: bold;
            color: #9333ea;
            margin: 20px 0;
            text-shadow: 0 0 10px rgba(147, 51, 234, 0.3);
        }

        /* Client-style leaderboard header */
        .game-compact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
            border: 2px solid #9333ea;
        }

        .team-score-display {
            flex: 1;
            text-align: center;
        }

        .team-score-display .score-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .team-score-display.red .score-value {
            color: #ff4757;
        }

        .team-score-display.green .score-value {
            color: #2ed573;
        }

        .team-score-display .score-label {
            font-size: 1rem;
            color: #666;
            font-weight: 600;
        }

        .game-timer-compact {
            flex: 0 0 120px;
            text-align: center;
            padding: 12px 18px;
            border-radius: 10px;
            background: #667eea;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            border: 2px solid #764ba2;
        }

        .game-timer-compact.timer-warmup {
            background: #f39c12;
            border-color: #e67e22;
        }

        .game-timer-compact.timer-safe {
            background: #2ed573;
            border-color: #26de81;
        }

        .game-timer-compact.timer-warning {
            background: #ffa502;
            border-color: #ff6348;
        }

        .game-timer-compact.timer-danger {
            background: #ff4757;
            border-color: #ff6348;
        }

        /* Player count display */
        .player-count-display {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #9333ea;
        }

        .player-count-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .player-count-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .player-count-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .player-count-item.red .player-count-value {
            color: #ff4757;
        }

        .player-count-item.green .player-count-value {
            color: #2ed573;
        }

        .player-count-item.total .player-count-value {
            color: #9333ea;
        }

        .player-count-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        /* Blocked IPs styling */
        .blocked-ip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: #fff0f0;
            border: 2px solid #ff4757;
            border-radius: 8px;
        }

        .blocked-ip-address {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #ff4757;
        }

        .unblock-btn {
            background: #2ed573;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .unblock-btn:hover {
            background: #26a65b;
            transform: scale(1.05);
        }

        /* Advanced settings checkbox styling */
        .advanced-settings-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .advanced-settings-container input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .advanced-settings-container label {
            cursor: pointer;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        /* Hide IP addresses and blocked IPs section by default */
        .ip-address-display {
            display: none;
        }

        .blocked-ips-section {
            display: none;
        }

        /* Show when advanced settings is checked */
        body.show-advanced .ip-address-display {
            display: inline;
        }

        body.show-advanced .blocked-ips-section {
            display: block;
        }

        /* Leaderboard columns matching client */
        .game-leaderboard-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .team-leaderboard {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid;
        }

        .team-leaderboard.red {
            border-color: #ff4757;
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.05) 0%, rgba(255, 71, 87, 0.02) 100%);
        }

        .team-leaderboard.green {
            border-color: #2ed573;
            background: linear-gradient(135deg, rgba(46, 213, 115, 0.05) 0%, rgba(46, 213, 115, 0.02) 100%);
        }

        .team-leaderboard h3 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .team-leaderboard.red h3 {
            color: #ff4757;
        }

        .team-leaderboard.green h3 {
            color: #2ed573;
        }

        /* Hide dashboard by default, show after login */
        body.login-mode .container {
            display: none;
        }
    </style>
</head>
<body class="login-mode">
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <h1>üéÆ Admin Login</h1>
        <p>Select your admin credentials file</p>
        <input type="file" id="fileInput" accept=".json">
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
            üîë Admin Login
        </button>
        <div id="errorMessage" class="error-message"></div>
    </div>

    <!-- Admin Dashboard (hidden until authenticated) -->
    <div class="container">
        <h1>üéÆ Admin Panel - Webinar Game</h1>

        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status connection-disconnected">
            ‚ö†Ô∏è Disconnected from server
        </div>

        <!-- Game State -->
        <div class="card">
            <h2>Game State<span id="gameStateBadge" class="status-badge status-idle">IDLE</span></h2>

            <div class="control-group">
                <label for="gameDuration">Game Duration (seconds):</label>
                <select id="gameDuration">
                    <option value="30">30 seconds</option>
                    <option value="60" selected>60 seconds (1 min)</option>
                    <option value="90">90 seconds (1.5 min)</option>
                    <option value="120">120 seconds (2 min)</option>
                    <option value="300">300 seconds (5 min)</option>
                </select>
            </div>

            <!-- 4 buttons in one row -->
            <div class="button-row">
                <!-- Main action button - changes based on state -->
                <button class="btn-primary" id="createResetBtn">Create Game</button>

                <!-- Start/Reset Scores button - changes based on state -->
                <button class="btn-success" id="startResetScoresBtn" disabled>Start Game</button>

                <!-- Finish Game button -->
                <button class="btn-danger" id="finishGameBtn" disabled>Finish Game</button>

                <!-- Delete Game button -->
                <button class="btn-danger-alt" id="deleteGameBtn" disabled>Delete Game Completely</button>
            </div>
        </div>

        <hr class="divider">

        <!-- Player Count Display -->
        <div class="player-count-display">
            <div class="player-count-row">
                <div class="player-count-item red">
                    <div class="player-count-value" id="redCount">0</div>
                    <div class="player-count-label">Red Team</div>
                </div>
                <div class="player-count-item total">
                    <div class="player-count-value" id="totalPlayers">0</div>
                    <div class="player-count-label">Total Players</div>
                </div>
                <div class="player-count-item green">
                    <div class="player-count-value" id="greenCount">0</div>
                    <div class="player-count-label">Green Team</div>
                </div>
            </div>
        </div>

        <!-- Team Scores and Timer (Client-style header) -->
        <div class="game-compact-header">
            <div class="team-score-display red">
                <div class="score-value" id="redTotal">0</div>
                <div class="score-label">◊ê◊ì◊ï◊ù</div>
            </div>

            <div class="game-timer-compact" id="timerDisplay">--:--</div>

            <div class="team-score-display green">
                <div class="score-value" id="greenTotal">0</div>
                <div class="score-label">◊ô◊®◊ï◊ß</div>
            </div>
        </div>

        <!-- Leaderboards (Client-style two columns) -->
        <div class="game-leaderboard-columns">
            <div class="team-leaderboard red">
                <h3>üî¥ Red Team</h3>
                <div class="leaderboard" id="redLeaderboard">
                    <p style="text-align: center; color: #666;">No players yet</p>
                </div>
            </div>
            <div class="team-leaderboard green">
                <h3>üü¢ Green Team</h3>
                <div class="leaderboard" id="greenLeaderboard">
                    <p style="text-align: center; color: #666;">No players yet</p>
                </div>
            </div>
        </div>

        <!-- Advanced Settings Toggle -->
        <div class="advanced-settings-container" style="margin-top: 20px;">
            <input type="checkbox" id="advancedSettingsToggle">
            <label for="advancedSettingsToggle">‚öôÔ∏è Advanced Settings</label>
        </div>

        <!-- Blocked IPs Section (hidden by default, shown only with advanced settings) -->
        <div class="card blocked-ips-section">
            <h2>üö´ Blocked IP Addresses</h2>
            <div id="blockedIPsContainer">
                <p style="color: #666; text-align: center;">No blocked IPs</p>
            </div>
        </div>
    </div>

    <!-- Socket.io Client -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        // Admin configuration (loaded from file)
        let adminConfig = null;
        let socket = null;
        let currentGameState = 'idle';
        let isConnected = false;

        console.log('Admin panel script loaded');

        // Wait for DOM to be ready before attaching event listeners
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded event fired');

            // Ensure login screen is visible
            document.body.classList.add('login-mode');
            console.log('Login mode activated');

            // Attach file upload handler
            const fileInput = document.getElementById('fileInput');
            console.log('File input element:', fileInput);

            fileInput.addEventListener('change', async (event) => {
                console.log('File input change event fired');
                const file = event.target.files[0];
                if (!file) {
                    console.log('No file selected');
                    return;
                }

                console.log('File selected:', file.name);

                const errorEl = document.getElementById('errorMessage');
                errorEl.textContent = '';

                try {
                    // Read file content
                    console.log('Reading file content...');
                    const text = await file.text();
                    console.log('File read, parsing JSON...');
                    const config = JSON.parse(text);
                    console.log('JSON parsed:', config);

                    // Validate config structure
                    if (!config.adminSecret || !config.serverUrl) {
                        throw new Error('Invalid credentials file format. Must contain adminSecret and serverUrl.');
                    }

                    // Store config in memory
                    adminConfig = config;

                    console.log('‚úÖ Credentials loaded successfully');
                    console.log('Server URL:', config.serverUrl);

                    // Connect to server
                    connectToServer();

                } catch (error) {
                    errorEl.textContent = '‚ùå ' + error.message;
                    console.error('Error loading credentials:', error);
                }
            });

            console.log('Event listener attached to file input');
        });

        function connectToServer() {
            if (!adminConfig) {
                console.error('No admin config loaded');
                return;
            }

            socket = io(adminConfig.serverUrl);

            socket.on('connect', () => {
                console.log('Connected to server');
                isConnected = true;

                // Authenticate as admin with secret
                socket.emit('admin_auth', {
                    adminSecret: adminConfig.adminSecret
                });
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                isConnected = false;
                updateConnectionStatus(false);

                // Return to login screen on disconnect
                document.body.classList.add('login-mode');
            });

            socket.on('admin_auth_success', (data) => {
                console.log('‚úÖ Admin authenticated successfully');

                // Hide login screen, show dashboard
                document.body.classList.remove('login-mode');
                updateConnectionStatus(true);
            });

            socket.on('admin_auth_error', (data) => {
                const errorEl = document.getElementById('errorMessage');
                errorEl.textContent = '‚ùå Authentication failed: ' + data.message;

                // Stay on login screen
                document.body.classList.add('login-mode');

                // Disconnect
                if (socket) {
                    socket.disconnect();
                }
            });

            socket.on('admin_dashboard', (data) => {
                updateDashboard(data);
            });

            socket.on('admin_update', (data) => {
                updateDashboard(data);
            });

            socket.on('admin_command_result', (result) => {
                if (!result.success) {
                    alert('Command failed: ' + result.message);
                } else {
                    console.log('Command succeeded:', result.message);
                }
            });

            socket.on('game_state_change', (data) => {
                updateGameState(data);
            });

            socket.on('timer_update', (data) => {
                updateTimer(data);
            });
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');

            // Get all control buttons and duration selector
            const createResetBtn = document.getElementById('createResetBtn');
            const startResetScoresBtn = document.getElementById('startResetScoresBtn');
            const finishGameBtn = document.getElementById('finishGameBtn');
            const deleteGameBtn = document.getElementById('deleteGameBtn');
            const durationSelector = document.getElementById('gameDuration');

            if (connected) {
                statusEl.className = 'connection-status connection-connected';
                statusEl.textContent = '‚úÖ Connected to server';

                // Re-enable controls (will be properly set by updateGameState)
                // Just remove the blanket disable, let game state logic handle it
            } else {
                statusEl.className = 'connection-status connection-disconnected';
                statusEl.textContent = '‚ö†Ô∏è Disconnected from server';

                // Disable ALL controls when disconnected
                createResetBtn.disabled = true;
                startResetScoresBtn.disabled = true;
                finishGameBtn.disabled = true;
                deleteGameBtn.disabled = true;
                durationSelector.disabled = true;
            }
        }

        function updateDashboard(data) {
            // Update game state
            updateGameState(data.gameState);

            // Update statistics
            document.getElementById('totalPlayers').textContent = data.playerCount || 0;
            document.getElementById('redCount').textContent = data.teamStats?.red || 0;
            document.getElementById('greenCount').textContent = data.teamStats?.green || 0;
            document.getElementById('redTotal').textContent = data.leaderboard?.red_team?.total?.toLocaleString() || 0;
            document.getElementById('greenTotal').textContent = data.leaderboard?.green_team?.total?.toLocaleString() || 0;

            // Update leaderboards
            updateLeaderboards(data.leaderboard);

            // Update blocked IPs
            updateBlockedIPs(data.blockedIPs);
        }

        function updateGameState(gameState) {
            currentGameState = gameState.state;
            const badge = document.getElementById('gameStateBadge');
            badge.textContent = gameState.state.toUpperCase();
            badge.className = 'status-badge status-' + gameState.state;

            // Get buttons
            const createResetBtn = document.getElementById('createResetBtn');
            const startResetScoresBtn = document.getElementById('startResetScoresBtn');
            const finishGameBtn = document.getElementById('finishGameBtn');
            const deleteGameBtn = document.getElementById('deleteGameBtn');

            // Get duration selector
            const durationSelector = document.getElementById('gameDuration');

            // If not connected, disable everything and return early
            if (!isConnected) {
                createResetBtn.disabled = true;
                startResetScoresBtn.disabled = true;
                finishGameBtn.disabled = true;
                deleteGameBtn.disabled = true;
                durationSelector.disabled = true;
                return;
            }

            // Update button labels and states based on game state
            if (gameState.state === 'idle') {
                // No game exists
                createResetBtn.textContent = 'Create Game';
                createResetBtn.disabled = false;
                createResetBtn.className = 'btn-primary';

                startResetScoresBtn.textContent = 'Start Game';
                startResetScoresBtn.disabled = true;

                finishGameBtn.disabled = true;
                deleteGameBtn.disabled = true;

                // Enable duration selector
                durationSelector.disabled = false;

            } else if (gameState.state === 'registration' || gameState.state === 'practice') {
                // Game created but not started
                createResetBtn.textContent = 'Reset Game + Delete All Members';
                createResetBtn.disabled = false;
                createResetBtn.className = 'btn-warning';

                startResetScoresBtn.textContent = 'Start Game';
                startResetScoresBtn.disabled = false;

                finishGameBtn.disabled = true;
                deleteGameBtn.disabled = false;

                // Enable duration selector (can still change before starting)
                durationSelector.disabled = false;

            } else if (gameState.state === 'active') {
                // Game is running
                createResetBtn.textContent = 'Reset Game + Delete All Members';
                createResetBtn.disabled = false;
                createResetBtn.className = 'btn-warning';

                startResetScoresBtn.textContent = 'Reset Scores & Restart Timer';
                startResetScoresBtn.disabled = false;

                finishGameBtn.disabled = false;
                deleteGameBtn.disabled = false;

                // Disable duration selector while game is running
                durationSelector.disabled = true;

            } else if (gameState.state === 'ended') {
                // Game ended
                createResetBtn.textContent = 'Reset Game + Delete All Members';
                createResetBtn.disabled = false;
                createResetBtn.className = 'btn-warning';

                startResetScoresBtn.textContent = 'Reset Scores & Restart Timer';
                startResetScoresBtn.disabled = false;

                finishGameBtn.disabled = true;
                deleteGameBtn.disabled = false;

                // Enable duration selector (can change for next round)
                durationSelector.disabled = false;
            }

            // Update timer
            if (gameState.timeRemaining !== undefined) {
                const mins = Math.floor(gameState.timeRemaining / 60);
                const secs = gameState.timeRemaining % 60;
                document.getElementById('timerDisplay').textContent =
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
        }

        function updateTimer(data) {
            const timerEl = document.getElementById('timerDisplay');
            timerEl.textContent = data.formattedTime;

            // Update timer color based on warm-up or time remaining
            timerEl.className = 'game-timer-compact';

            if (data.inWarmup) {
                timerEl.classList.add('timer-warmup');
            } else if (data.timeRemaining > 30) {
                timerEl.classList.add('timer-safe');
            } else if (data.timeRemaining > 15) {
                timerEl.classList.add('timer-warning');
            } else {
                timerEl.classList.add('timer-danger');
            }
        }

        function updateLeaderboards(leaderboard) {
            if (!leaderboard) return;

            // Red team
            const redEl = document.getElementById('redLeaderboard');
            if (leaderboard.red_team.players.length === 0) {
                redEl.innerHTML = '<p style="text-align: center; color: #666;">No players yet</p>';
            } else {
                redEl.innerHTML = leaderboard.red_team.players.map((player, index) => `
                    <div class="player-row-container">
                        <div class="player-row red">
                            <span>${index + 1}. ${player.name} <small class="ip-address-display" style="color: #888; font-size: 0.75em;">(${player.ipAddress || 'N/A'})</small></span>
                            <span style="font-weight: bold; color: #667eea;">${player.score.toLocaleString()}</span>
                        </div>
                        <button class="delete-player-btn" onclick="deletePlayer('${player.uuid}')" title="Delete player">üóëÔ∏è</button>
                    </div>
                `).join('');
            }

            // Green team
            const greenEl = document.getElementById('greenLeaderboard');
            if (leaderboard.green_team.players.length === 0) {
                greenEl.innerHTML = '<p style="text-align: center; color: #666;">No players yet</p>';
            } else {
                greenEl.innerHTML = leaderboard.green_team.players.map((player, index) => `
                    <div class="player-row-container">
                        <div class="player-row green">
                            <span>${index + 1}. ${player.name} <small class="ip-address-display" style="color: #888; font-size: 0.75em;">(${player.ipAddress || 'N/A'})</small></span>
                            <span style="font-weight: bold; color: #667eea;">${player.score.toLocaleString()}</span>
                        </div>
                        <button class="delete-player-btn" onclick="deletePlayer('${player.uuid}')" title="Delete player">üóëÔ∏è</button>
                    </div>
                `).join('');
            }
        }

        function updateBlockedIPs(blockedIPs) {
            const container = document.getElementById('blockedIPsContainer');

            if (!blockedIPs || blockedIPs.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No blocked IPs</p>';
                return;
            }

            container.innerHTML = blockedIPs.map(ip => `
                <div class="blocked-ip-item">
                    <span class="blocked-ip-address">${ip}</span>
                    <button class="unblock-btn" onclick="unblockIP('${ip}')">Unblock</button>
                </div>
            `).join('');
        }

        function unblockIP(ipAddress) {
            if (confirm(`Unblock IP address ${ipAddress}?\n\nThis user will be able to register again.`)) {
                socket.emit('admin_command', {
                    adminSecret: adminConfig.adminSecret,
                    command: 'unblock_ip',
                    payload: { ipAddress }
                });
            }
        }

        // Button handlers

        // Create/Reset button - dual purpose based on state
        document.getElementById('createResetBtn').addEventListener('click', () => {
            const duration = parseInt(document.getElementById('gameDuration').value);

            if (currentGameState === 'idle') {
                // Create game
                socket.emit('admin_command', {
                    adminSecret: adminConfig.adminSecret,
                    command: 'reset_game_with_members',
                    payload: { duration }
                });
            } else {
                // Reset game with all members deleted
                if (confirm('Reset the entire game and DELETE ALL MEMBERS? This will:\n- Remove all registered players\n- Clear all scores\n- Return to registration state\n- All connected users will be logged out\n\nAre you sure?')) {
                    socket.emit('admin_command', {
                        adminSecret: adminConfig.adminSecret,
                        command: 'reset_game_with_members',
                        payload: { duration }
                    });
                }
            }
        });

        // Start/Reset Scores button - dual purpose based on state
        document.getElementById('startResetScoresBtn').addEventListener('click', () => {
            const duration = parseInt(document.getElementById('gameDuration').value);

            if (currentGameState === 'registration' || currentGameState === 'practice') {
                // Start game
                if (confirm('Start the game? All scores will be reset to zero.')) {
                    socket.emit('admin_command', {
                        adminSecret: adminConfig.adminSecret,
                        command: 'start_game',
                        payload: { duration }
                    });
                }
            } else if (currentGameState === 'active' || currentGameState === 'ended') {
                // Reset scores and restart timer
                if (confirm('Reset all scores to zero and restart the timer? All players will remain registered and can continue playing.')) {
                    socket.emit('admin_command', {
                        adminSecret: adminConfig.adminSecret,
                        command: 'reset_scores_and_time',
                        payload: { duration }
                    });
                }
            }
        });

        // Finish game button
        document.getElementById('finishGameBtn').addEventListener('click', () => {
            if (confirm('Finish the game?')) {
                socket.emit('admin_command', {
                    adminSecret: adminConfig.adminSecret,
                    command: 'stop_game'
                });
            }
        });

        // Delete game completely
        document.getElementById('deleteGameBtn').addEventListener('click', () => {
            if (confirm('DELETE the game completely? This will:\n- Remove the game entirely\n- All users return to form view\n- No "Game On" button will appear\n- You will need to create a new game manually\n\nAre you sure?')) {
                socket.emit('admin_command', {
                    adminSecret: adminConfig.adminSecret,
                    command: 'delete_game'
                });
            }
        });

        // Delete player function
        function deletePlayer(uuid) {
            if (confirm('Are you sure you want to delete this player? Their score will be removed from the team total.')) {
                socket.emit('admin_command', {
                    adminSecret: adminConfig.adminSecret,
                    command: 'delete_player',
                    payload: { uuid }
                });
            }
        }

        // Duration selector change listener
        // Updates timer display in real-time when duration changes (but only when game is not active)
        document.getElementById('gameDuration').addEventListener('change', (event) => {
            const duration = parseInt(event.target.value);

            // Only update display if game is not active (idle, registration, practice, or ended)
            if (currentGameState !== 'active') {
                const mins = Math.floor(duration / 60);
                const secs = duration % 60;
                document.getElementById('timerDisplay').textContent =
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
        });

        // Advanced Settings Toggle
        document.getElementById('advancedSettingsToggle').addEventListener('change', (event) => {
            if (event.target.checked) {
                document.body.classList.add('show-advanced');
            } else {
                document.body.classList.remove('show-advanced');
            }
        });
    </script>
</body>
</html>
